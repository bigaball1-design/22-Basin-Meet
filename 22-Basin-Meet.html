<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empire Basin 2.7 | Executive Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        :root { 
            --bg: #0a0a0a; --card: #151515; --text: #d1d1d1; --dim: #666;
            --primary: #80cbc4; --accent: #ce93d8; --orange: #ffcc80; --border: #222;
            --blue: #90caf9; --green: #a5d6a7; --purple: #b39ddb;
        }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        
        /* Navigation */
        .nav-bar { display: flex; background: #000; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .nav-item { padding: 15px 25px; cursor: pointer; color: var(--dim); border-bottom: 3px solid transparent; font-size: 13px; font-weight: 600; text-transform: uppercase; }
        .nav-item.active { border-color: var(--primary); color: var(--primary); background: rgba(128,203,196,0.05); }

        .container { padding: 20px; max-width: 1600px; margin: 0 auto; }
        .tab-content { display: none; } .tab-content.active { display: block; }

        /* Section Headers */
        .section-header { font-size: 24px; color: var(--primary); margin: 20px 0; border-bottom: 2px solid var(--border); padding-bottom: 10px; }

        /* Basin Console - Grid Layout */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .basin-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 25px; cursor: pointer; transition: 0.3s; position: relative; }
        .basin-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .basin-card h2 { font-size: 28px; color: var(--primary); margin: 0 0 10px 0; font-family: 'JetBrains Mono'; }
        
        .type-label { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-bottom: 10px; color: #000; }
        .status-badge { font-size: 14px; padding: 5px 12px; border-radius: 6px; font-weight: 600; border: 1px solid; margin-top: 15px; display: inline-block; }
        
        .st-upcoming { color: var(--orange); border-color: var(--orange); background: rgba(255,204,128,0.05); }
        .st-finished { color: var(--green); border-color: var(--green); background: rgba(165,214,167,0.05); }

        /* Progress Grid - 2 Columns */
        .progress-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .p-row { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 12px 20px; display: grid; grid-template-columns: 160px 1fr 60px; align-items: center; gap: 15px; }
        .p-name { font-size: 15px; font-weight: 600; color: var(--primary); }
        .bar-bg { height: 8px; background: #222; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--primary)); transition: 1s; }

        /* Modal Summary */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; padding: 20px; overflow-y: auto; }
        .modal-content { background: var(--card); max-width: 800px; margin: 20px auto; padding: 40px; border-radius: 15px; border: 1px solid var(--border); }
        .fee-tag { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono'; margin: 15px 0; }

        #calendar { background: #000; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        @media (max-width: 1000px) { .progress-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('main', this)">Basin Console</div>
        <div class="nav-item" onclick="switchTab('progress', this)">Progress Tracker</div>
        <div class="nav-item" onclick="switchTab('cal', this)">Calendar View</div>
    </div>

    <div class="container">
        <div id="tab-main" class="tab-content active">
            <div class="section-header">üìÖ ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á (Upcoming)</div>
            <div id="grid-upcoming" class="grid"></div>
            <div style="margin: 50px 0; border-top: 1px dashed #444;"></div>
            <div class="section-header">‚úÖ ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß (Historical)</div>
            <div id="grid-finished" class="grid" style="opacity: 0.7;"></div>
        </div>

        <div id="tab-progress" class="tab-content">
            <div class="section-header">üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ 22 ‡∏•‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≥</div>
            <div id="p-list" class="progress-grid"></div>
        </div>

        <div id="tab-cal" class="tab-content">
            <div id="calendar"></div>
        </div>
    </div>

    <div id="modal" class="modal" onclick="this.style.display='none'"><div class="modal-content" onclick="event.stopPropagation()" id="m-body"></div></div>

<script>
    const LOG_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5hALcSBPp06GcYUqubUzlQM6_spndAbjd4nuhA9ekKFGkA8gldNXj1frx3gjn-6Tg0eS-HuAI9bUw/pub?gid=0&single=true&output=csv';
    const PROF_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5hALcSBPp06GcYUqubUzlQM6_spndAbjd4nuhA9ekKFGkA8gldNXj1frx3gjn-6Tg0eS-HuAI9bUw/pub?gid=1235957743&single=true&output=csv';
    
    const TYPE_COLORS = { "Inception": "#90caf9", "‡∏õ‡∏ê‡∏°‡∏ô‡∏¥‡πÄ‡∏ó‡∏®": "#a5d6a7", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢": "#ffcc80", "Final": "#ce93d8" };
    const STEPS = ["Inception", "Progress", "Interim", "Progress 2", "Draft Final", "Final"];
    let db = { profiles: {}, logs: [] };

    function parseDate(dStr) {
        if (!dStr) return null;
        const parts = dStr.trim().split('/');
        if (parts.length === 3) return new Date(`${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`);
        const iso = new Date(dStr.trim());
        return isNaN(iso.getTime()) ? null : iso;
    }

    async function start() {
        try {
            const [pRes, lRes] = await Promise.all([fetch(PROF_URL), fetch(LOG_URL)]);
            const pTxt = await pRes.text();
            pTxt.split('\n').slice(1).forEach(r => {
                const c = r.split(',').map(s => s.trim());
                if (c[0]) db.profiles[c[0]] = { full: c[1], company: c[2], staff: c[3], link: c[4] };
            });
            const lTxt = await lRes.text();
            db.logs = lTxt.split('\n').map(r => r.split(',').map(s => s.trim())).filter((c, i) => i > 0 && c[3]);
            render();
        } catch (e) { console.error("Sync Error", e); }
    }

    function render() {
        const now = new Date();
        const upGrid = document.getElementById('grid-upcoming');
        const finGrid = document.getElementById('grid-finished');
        upGrid.innerHTML = ''; finGrid.innerHTML = '';

        const uniqueBasins = [...new Set(db.logs.map(l => l[3]))];
        const basinData = uniqueBasins.map(nick => {
            const logs = db.logs.filter(l => l[3] === nick).map(l => ({...l, dt: parseDate(l[4])})).filter(l => l.dt);
            const next = logs.sort((a,b) => a.dt - b.dt).find(l => l.dt >= now.setHours(0,0,0,0)) || logs[logs.length-1];
            return { nick, next };
        });

        // 1. Render Console Cards
        basinData.sort((a,b) => (a.next?.dt || 0) - (b.next?.dt ||
